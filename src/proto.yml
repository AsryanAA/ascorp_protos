version: '3'

vars:
  PROTOC_GEN_GO_VERSION: 'v1.36.4'
  PROTOC_GEN_GO_BIN: '{{.PROJECT_BIN}}/protoc-gen-go_{{.PROTOC_GEN_GO_VERSION}}'

  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'
  PROTOC_GEN_GO_GRPC_BIN: '{{.PROJECT_BIN}}/protoc-gen-go-grpc_{{.PROTOC_GEN_GO_GRPC_VERSION}}'

tasks:
  generate:
    desc: Сгенерировать proto файлы, пример "task proto:generate"
    deps: [ init ]
    cmds:
      - |
        protoc --proto_path={{.USER_WORKING_DIR}}/src \
        --plugin=protoc-gen-go={{.PROTOC_GEN_GO_BIN}} --go_out={{.USER_WORKING_DIR}}/pkg --go_opt=paths=source_relative \
        --plugin=protoc-gen-go-grpc={{.PROTOC_GEN_GO_GRPC_BIN}} --go-grpc_out={{.USER_WORKING_DIR}}/pkg --go-grpc_opt=paths=source_relative {{.USER_WORKING_DIR}}/src/core/auth.proto

  generate1:
    desc: Сгенерировать proto файлы, пример "task proto:generate1"
    deps: [ init ]
    cmds:
      - |
        protoc -I {{.USER_WORKING_DIR}}/src/core \
        --plugin=protoc-gen-go={{.PROTOC_GEN_GO_BIN}} --go_out={{.USER_WORKING_DIR}}/pkg --go_opt=paths=source_relative \
        --plugin=protoc-gen-go-grpc={{.PROTOC_GEN_GO_GRPC_BIN}} --go-grpc_out={{.USER_WORKING_DIR}}/pkg --go-grpc_opt=paths=source_relative {{.USER_WORKING_DIR}}/src/core/auth.proto

  init:
    desc: Подгрузить protoc
    silent: true
    cmds:
      - '[ -f {{.PROJECT_BIN}} ] || mkdir -p {{.PROJECT_BIN}}'
      - '[ -f {{.PROTOC_GEN_GO_BIN}} ] || (GOBIN={{.PROJECT_BIN}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}} && mv {{.PROJECT_BIN}}/protoc-gen-go {{.PROTOC_GEN_GO_BIN}})'
      - '[ -f {{.PROTOC_GEN_GO_GRPC_BIN}} ] || (GOBIN={{.PROJECT_BIN}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}} && mv {{.PROJECT_BIN}}/protoc-gen-go-grpc {{.PROTOC_GEN_GO_GRPC_BIN}})'